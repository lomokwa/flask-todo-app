{% extends "layout.html" %}

{% block content %}

<!-- Script to handle edit and task status updates -->
<script>
  function updateTable(tasks) {
    const tbody = document.querySelector('table tbody');
    tbody.innerHTML = '';
    
    tasks.forEach(task => {
      const row = document.createElement('tr');
      row.id = task.id;
      
      // Format the date for display
      const displayDate = new Date(task.due_date).toLocaleDateString('en-US');
      const isoDate = task.due_date; // Already in YYYY-MM-DD format from server
      
      row.innerHTML = `
        <td>
          <button class="status-btn" data-status="${task.is_done ? 'done' : 'not-done'}">
            ${task.is_done ? '✔' : ''}
          </button>
        </td>
        <td>
          <span class="task-name">${task.name}</span>
          <input type="text" class="task-name-edit" value="${task.name}" style="display:none;">
        </td>
        <td>
          <span class="task-due-date">${displayDate}</span>
          <input type="date" class="task-due-date-edit" value="${isoDate}" style="display:none;">
        </td>
        <td>
          <button class="edit-btn">Edit</button>
          <button class="save-btn" style="display:none;">Save</button>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    // Reattach event listeners to the new elements
    attachEventListeners();
  }
  
  function attachEventListeners() {
    // Edit button listeners
    document.querySelectorAll('.edit-btn').forEach(button => {
      button.addEventListener('click', function() {
        const taskRow = this.closest('tr');
        taskRow.querySelector('.task-name').style.display = 'none';
        taskRow.querySelector('.task-name-edit').style.display = 'inline';
        taskRow.querySelector('.task-due-date').style.display = 'none';
        taskRow.querySelector('.task-due-date-edit').style.display = 'inline';
        this.style.display = 'none';
        taskRow.querySelector('.save-btn').style.display = 'inline';
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.edit-btn').forEach(button => {
      button.addEventListener('click', function() {
        const taskRow = this.closest('tr');
        taskRow.querySelector('.task-name').style.display = 'none';
        taskRow.querySelector('.task-name-edit').style.display = 'inline';
        taskRow.querySelector('.task-due-date').style.display = 'none';
        taskRow.querySelector('.task-due-date-edit').style.display = 'inline';
        this.style.display = 'none';
        taskRow.querySelector('.save-btn').style.display = 'inline';
      });
    });

    document.querySelectorAll('.save-btn').forEach(button => {
      button.addEventListener('click', function() {
        const taskRow = this.closest('tr');
        const taskId = taskRow.id;
        const updatedName = taskRow.querySelector('.task-name-edit').value;
        const updatedDueDate = taskRow.querySelector('.task-due-date-edit').value;

        fetch(`/update-task/${taskId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: updatedName,
            due_date: updatedDueDate
          })
        }).then(response => {
          if (response.ok) {
            taskRow.querySelector('.task-name').textContent = updatedName;
            taskRow.querySelector('.task-due-date').textContent = updatedDueDate;
            taskRow.querySelector('.task-name').style.display = 'inline';
            taskRow.querySelector('.task-name-edit').style.display = 'none';
            taskRow.querySelector('.task-due-date').style.display = 'inline';
            taskRow.querySelector('.task-due-date-edit').style.display = 'none';
            this.style.display = 'none';
            taskRow.querySelector('.edit-btn').style.display = 'inline';
          }
        });
      });
    });

    document.querySelectorAll('.status-btn').forEach(button => {
      button.addEventListener('click', function() {
        const taskRow = this.closest('tr');
        const taskId = taskRow.id;
        const newStatus = this.dataset.status === 'done' ? 'not-done' : 'done';

        fetch(`/update-task-status/${taskId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            is_done: newStatus === 'done'
          })
        }).then(response => {
          if (response.ok) {
            this.textContent = newStatus === 'done' ? '✔' : '';
            this.dataset.status = newStatus;
          }
        });
      });
    });

    document.querySelectorAll('.sort-btn').forEach(button => {
      button.addEventListener('click', async function() {
        const sortBy = this.dataset.sort;
        let order = this.dataset.order;
        
        try {
          const res = await fetch(`/tasks?sort_by=${sortBy}&order=${order}`, {
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
  
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
  
          const tasks = await res.json();
          updateTable(tasks);
          
          order = order === 'asc' ? 'desc' : 'asc';
          this.dataset.order = order;
          
        } catch (err) {
          console.error('Error:', err.message);
        }
      });
    });

  });

</script>

<h1>Flask Todo App</h1>

<form method="post" action="{{ url_for('add_task') }}">
  <label>
    Task Name:
    <input type="text" name="name">
  </label>
  <label>
    Due Date:
    <input type="date" name="due_date">
  </label>
  <input type="submit" value="Add New Task">
</form>

{% if tasks %}
<table>
  <thead>
    <tr>
      <th>
          Status
          <button class="sort-btn" data-sort="is_done" data-order="asc">sort</button>
      </th>
      <th>
          Task Name
          <button class="sort-btn" data-sort="name" data-order="asc">sort</button>
      </th>
      <th>
          Due Date
          <button class="sort-btn" data-sort="due_date" data-order="asc">sort</button>
      </th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for task in tasks %}
    <tr id="{{ task['id'] }}">
      <td>
        {% if task.is_done %}
        <button class="status-btn" data-status="done">✔</button>
        {% else %}
        <button class="status-btn" data-status="not-done"></button>
        {% endif %}
      </td>
      <td>
        <span class="task-name">{{ task.name }}</span>
        <input type="text" class="task-name-edit" value="{{ task['name'] }}" style="display:none;">
      </td>
      <td>
        <span class="task-due-date">{{ task.due_date.strftime('%m/%d/%Y') }}</span>
        <input type="date" class="task-due-date-edit" value="{{ task.due_date.strftime('%Y-%m-%d') }}" style="display:none;">
      </td>
      <td>
        <button class="edit-btn">Edit</button>
        <button class="save-btn" style="display:none;">Save</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<h2>No tasks added. Start by creating a new task</h2>
{% endif %}
{% endblock %}
