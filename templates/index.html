{% extends "layout.html" %}

{% block content %}

<!-- Script to handle edit and task status updates -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.edit-btn').forEach(button => {
      button.addEventListener('click', function () {
        const taskRow = this.closest('tr');
        taskRow.querySelector('.task-name').style.display = 'none';
        taskRow.querySelector('.task-name-edit').style.display = 'inline';
        taskRow.querySelector('.task-due-date').style.display = 'none';
        taskRow.querySelector('.task-due-date-edit').style.display = 'inline';
        this.style.display = 'none';
        taskRow.querySelector('.save-btn').style.display = 'inline';
      });
    });

    document.querySelectorAll('.save-btn').forEach(button => {
      button.addEventListener('click', function () {
        const taskRow = this.closest('tr');
        const taskId = taskRow.id;
        const updatedName = taskRow.querySelector('.task-name-edit').value;
        const updatedDueDate = taskRow.querySelector('.task-due-date-edit').value;

        fetch(`/update-task/${taskId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: updatedName,
            due_date: updatedDueDate
          })
        }).then(response => {
          if (response.ok) {
            taskRow.querySelector('.task-name').textContent = updatedName;
            taskRow.querySelector('.task-due-date').textContent = updatedDueDate;
            taskRow.querySelector('.task-name').style.display = 'inline';
            taskRow.querySelector('.task-name-edit').style.display = 'none';
            taskRow.querySelector('.task-due-date').style.display = 'inline';
            taskRow.querySelector('.task-due-date-edit').style.display = 'none';
            this.style.display = 'none';
            taskRow.querySelector('.edit-btn').style.display = 'inline';
          }
        });
      });
    });

    document.querySelectorAll('.status-btn').forEach(button => {
      button.addEventListener('click', function () {
        const taskRow = this.closest('tr');
        const taskId = taskRow.id;
        const newStatus = this.dataset.status === 'done' ? 'not-done' : 'done';

        fetch(`/update-task-status/${taskId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            is_done: newStatus === 'done'
          })
        }).then(response => {
          if (response.ok) {
            this.textContent = newStatus === 'done' ? '✔' : '';
            this.dataset.status = newStatus;
          }
        });
      });
    });
  });

</script>

<h1>Flask Todo App</h1>

<form method="post" action="{{ url_for('add_task') }}">
  <label>
    Task Name:
    <input type="text" name="name">
  </label>
  <label>
    Due Date:
    <input type="date" name="due_date">
  </label>
  <input type="submit" value="Add New Task">
</form>

{% if tasks %}
<table>
  <thead>
    <tr>
      <th>Status</th>
      <th>Task Name</th>
      <th>Due Date</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for task in tasks %}
    <tr id="{{ task['id'] }}">
      <td>
        {% if task.is_done %}
        <button class="status-btn" data-status="done">✔</button>
        {% else %}
        <button class="status-btn" data-status="not-done"></button>
        {% endif %}
      </td>
      <td>
        <span class="task-name">{{ task.name }}</span>
        <input type="text" class="task-name-edit" value="{{ task['name'] }}" style="display:none;">
      </td>
      <td>
        <span class="task-due-date">{{ task.due_date.strftime('%m/%d/%Y') }}</span>
        <input type="date" class="task-due-date-edit" value="{{ task.due_date.strftime('%Y-%m-%d') }}" style="display:none;">
      </td>
      <td>
        <button class="edit-btn">Edit</button>
        <button class="save-btn" style="display:none;">Save</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<h2>No tasks added. Start by creating a new task</h2>
{% endif %}
{% endblock %}
